# Scoring API

## Задание
Реализовать декларативный язык описания и систему валидации
запросов ĸ HTTP API сервиса скоринга. Шаблон уже есть в api.py, тесты в test.py,
функционал подсчета сĸора в scoring.py. API необычно тем, что пользователи
дергают методы POST запросами. Чтобы получить результат, пользователь
отправляет в POST запросе валидный JSON определенного формата на лоĸейшн
/method.
Disclaimer: данное API ни в коей мере не являет собой best practice реализации
подобных вещей и намеренно сделано "странно" в неĸоторых местах.

### Веб-сервер должен уметь:
1) Масштабироваться на несколько worker'ов
2) Число worker'ов задается аргументом командной строки - w
3) отвечать 200, 403 или 404 на GET-запросы и HEAD-запросы
4) отвечать 405 на прочие запросы
5) Возвращать файлы по произвольному пути в DOCUMENT_ROOT.
6) Вызов /file.html должен возвращать содержимое DOCUMENT_ROOT/file.html
7) DOCUMENT_ROOT задается аргументом командной строки - r
8) Возвращать index.html как индекс директории
9) Вызов /directory/ должен возвращать DOCUMENT_ROOT/directory/index.html
10) отвечать следующими заголовками для успешных GET-запросов: Date, Server, Content-Length, Content-Type, Connection
11) Корректный Content-Type для: .html, .css, .js, .jpg, .jpeg, .png, .gif, .swf
12) Понимать пробелы и %XX в именах файлов  


### Структура запроса
```{"account": "<имя компании партнера>", "login": "<имя пользователя>", "method": "<имя метода>", "token": "<аутентификационный токен>", "arguments": {<словарь с аргументами вызываемого метода>}} ```

account - строка, опционально, может быть пустым
login - строка, обязательно, может быть пустым
method - строка, обязательно, может быть пустым
token - строка, обязательно, может быть пустым
arguments - словарь (объект в терминах json), обязательно, может быть пустым
file:///tmp/03_oop/homework/doc.html

### Валидация
Запрос валиден, если валидны все поля по отдельности
#### Структура ответа
OK: `{"code": <числовой код>, "response": {<ответ вызываемого метода>}}`

#### Ошибка:
status_code: `{"code": <числовой код>, "error": {<сообщение об ошибке>}}`

#### Аутентификация:
В случае если не пройдена, нужно возвращать: `{"code": 403, "error": "Forbidden"}`

### Методы
#### Метод online_score
**Аргументы**  
phone - строка или число, длиной 11, начинается с 7, опционально, может быть пустым  
email - строка, в которой есть @, опционально, может быть пустым  
first_name - строка, опционально, может быть пустым  
last_name - строка, опционально, может быть пустым  
birthday - дата в формате DD.MM.YYYY, с которой прошло не больше 70 лет, опционально, может быть пустым  
gender - число 0, 1 или 2, опционально, может быть пустым  

**Валидация аргументов**  
Аргументы валидны, если валидны все поля по отдельности и если присутсвует хоть одна пара phone-email, first name-last name, gender-birthday с непустыми значениями.

**Контекст**  
В словарь контекста должна прописываться запись "has" - список полей,
которые были не пустые для данного запроса

**Ответ**  
В ответ выдается число, полученное вызовом функции get_score (см. scoring.py). Но если пользователь админ (см. check_auth), то нужно всегда отдавать 42.  
`{"score": <число>}`

или если запрос пришел от валидного пользователя admin  
`{"score": 42}`

или если произошла ошибка валидации  
`{"code": 422, "error": "<сообщение о том какое поле(я) невалидно(ы) и как именно>"}`

**Пример**
```
$ curl -X POST -H "Content-Type: application/json" -d '
{"account": "horns&hoofs", "login": "h&f", "method":"online_score", 
"token": "55cc9ce545bcd144300fe9efc28e65d415b923ebb6be1e19d2750a2c03e80dd209a27954dca045e5bb12418e7d89b6d718a9e35af34e14e1d5bcd 
"arguments": {"phone": "79175002040", "email": "stupnikov@otus.ru", "first_name": "Стансилав", "last_name": "Ступников", 
"birthday": "01.01.1990", "gender": 1}}' http://127.0.0.1:8080/method/
```  
Ответ  
`{"code": 200, "response": {"score": 5.0}}`

#### Метод clients_interests.
**Аргументы**
client_ids - массив числе, обязательно, не пустое  
date - дата в формате DD.MM.YYYY, опционально, может быть пустым  

**Валидация аругементов**  
Аргументы валидны, если валидны все поля по отдельности.

**Контекст**  
В словарь контекста должна прописываться запись "nclients" количество id'шников, переданных в запрос

**Ответ** 
В ответ выдается словарь `<id клиента>:<список интересов>`  
Список генерировать вызовом функции get_interests (см. scoring.py).  
`{"client_id1": ["interest1", "interest2" ...], "client2": [...] ...}`  
или если произошла ошибка валидации  
`{"code": 422, "error": "<сообщение о том какое поле(я) невалидно(ы) и как именно>"}`  

**Пример**
```
curl -X POST -H "Content-Type: application/json" -d '{"account": "horns&hoofs", "login": "admin", "method":
"clients_interests", "token":
"d3573aff1555cd67dccf21b95fe8c4dc8732f33fd4e32461b7fe6a71d83c947688515e36774c00fb630b039fe2223c991f045f13f240913860502
"arguments": {"client_ids": [1,2,3,4], "date": "20.07.2017"}}' http://127.0.0.1:8080/method/
```
### Логирование  
Сĸрипт должен писать логи через библиотеĸу logging в формате:  
`[%(asctime)s] %(levelname).1s %(message)s` c датой в виде '%Y.%m.%d %H:%M:%S'.  
Допускается только использование уровней info, error и exception.  
Путь до логфайла указывается в ĸонфиге, если не указан, лог должен писаться в stdout

### Запуск проекта
1) Установка зависимостей `poetry install`
2) Запуск `python3 api.py`
